@page "/scan"
@using Microsoft.AspNetCore.Authorization
@using WebGhiHinh.Models
@using WebGhiHinh.Controllers
@using Microsoft.AspNetCore.Components.Authorization
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

@* 👇 Tắt Prerendering để đảm bảo JS chạy được ngay khi vào trang *@
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>Quét Mã QR</PageTitle>

<AuthorizeView>
    <Authorized>
        <!-- NẾU ĐÃ ĐĂNG NHẬP: Hiển thị nội dung chính -->
        <div class="scan-container">
            <div class="scan-card">

                @if (occupiedStation == null)
                {
                    /* === GIAO DIỆN 1: CHỌN TRẠM === */
                    <h1 class="scan-header">Vui lòng chọn trạm làm việc</h1>

                    @if (loading)
                    {
                        <div class="spinner"></div>
                        <p>Đang tải danh sách trạm...</p>
                    }
                    else if (stations.Count == 0)
                    {
                        <p class="text-muted">Chưa có trạm nào được tạo. Vui lòng liên hệ Admin.</p>
                    }
                    else
                    {
                        <div class="station-grid">
                            @foreach (var station in stations)
                            {
                                var isBusy = station.CurrentUserId != null;
                                <div class="station-box @(isBusy ? "disabled" : "")"
                                     @onclick="() => OccupyStation(station)">
                                    <span class="station-box-name">@station.Name</span>
                                    @if (isBusy)
                                    {
                                        <span class="station-box-user">🔴 Đang có người: @(station.CurrentUser?.Username ?? "N/A")</span>
                                    }
                                    else
                                    {
                                        <span class="station-box-free">🟢 Trống</span>
                                    }
                                </div>
                            }
                        </div>
                    }
                }
                else
                {
                    /* === GIAO DIỆN 2: QUÉT MÃ (SAU KHI VÀO TRẠM) === */
                    <div class="header-actions">
                        <h2 class="scan-header">Trạm: @occupiedStation.Name</h2>
                        <button class="btn btn-danger btn-sm" @onclick="ReleaseStation">
                            🚪 Rời trạm
                        </button>
                    </div>

                    <!-- KHUNG CAMERA -->
                    @if (isCameraActive)
                    {
                        <div class="qr-camera">
                            <video @ref="videoElement" class="qr-video" muted playsinline></video>
                            <canvas @ref="canvasElement" class="qr-canvas" hidden></canvas>
                            <div class="qr-overlay">
                                <div class="qr-scan-line"></div>
                            </div>
                        </div>
                    }

                    <div class="qr-button-group">
                        @if (!isCameraActive)
                        {
                            <button class="btn btn-primary" @onclick="StartCamera" disabled="@(!isJsqrLoaded)">
                                📷 Bật Camera
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-warning" @onclick="StopCamera">
                                🛑 Tắt Camera
                            </button>
                        }
                    </div>

                    <div class="text-divider">--- hoặc nhập mã thủ công ---</div>

                    <form @onsubmit="HandleManualSubmit">
                        <input type="text" class="scan-input" placeholder="Nhập mã QR sản phẩm..."
                               @bind="manualCode" disabled="@isSubmitting" />
                    </form>

                    @if (isSubmitting)
                    {
                        <div class="spinner mt-3"></div>
                    }

                    @if (!string.IsNullOrEmpty(statusMessage))
                    {
                        <div class="alert @(statusType == "success" ? "alert-success" : "alert-danger") mt-3">
                            @statusMessage
                        </div>
                    }
                }
            </div>
        </div>
    </Authorized>
    <NotAuthorized>
        <!-- NẾU CHƯA ĐĂNG NHẬP: Hiện thông báo và chuyển hướng -->
        <div class="text-center mt-5">
            <h3>Bạn chưa đăng nhập!</h3>
            <p>Đang chuyển hướng về trang đăng nhập...</p>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    // --- State ---
    private List<Station> stations = new();
    private Station? occupiedStation = null;
    private bool loading = true;
    private bool isCameraActive = false;
    private bool isSubmitting = false;
    private bool isJsqrLoaded = false;
    private string manualCode = "";
    private string statusMessage = "";
    private string statusType = "info";

    // --- JS References ---
    private ElementReference videoElement;
    private ElementReference canvasElement;
    private DotNetObjectReference<ScanningPage>? objRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Kiểm tra đăng nhập thủ công lần đầu
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            if (!authState.User.Identity.IsAuthenticated)
            {
                Nav.NavigateTo("/login");
                return;
            }

            // Kiểm tra thư viện QR
            try
            {
                isJsqrLoaded = await JS.InvokeAsync<bool>("eval", "typeof jsQR !== 'undefined'");
                await LoadStations();
                StateHasChanged();
            }
            catch { }
        }
    }

    private async Task LoadStations()
    {
        try
        {
            await AttachTokenToHttp();
            stations = await Http.GetFromJsonAsync<List<Station>>("api/station") ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Lỗi tải trạm: {ex.Message}");
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private async Task OccupyStation(Station station)
    {
        if (station.CurrentUserId != null) return;

        try
        {
            await AttachTokenToHttp();
            var response = await Http.PostAsJsonAsync("api/station/occupy", new { StationId = station.Id });

            if (response.IsSuccessStatusCode)
            {
                occupiedStation = station;
                statusMessage = "";
            }
            else
            {
                var error = await response.Content.ReadFromJsonAsync<dynamic>();
                statusMessage = $"Lỗi: {error.GetProperty("message")}";
                statusType = "error";
            }
        }
        catch (Exception)
        {
            statusMessage = "Lỗi kết nối đến máy chủ!";
            statusType = "error";
        }
    }

    private async Task ReleaseStation()
    {
        if (occupiedStation == null) return;
        await StopCamera();

        try
        {
            await AttachTokenToHttp();
            await Http.PostAsJsonAsync("api/station/release", new { StationId = occupiedStation.Id });
            occupiedStation = null;
            manualCode = "";
            statusMessage = "";
            await LoadStations();
        }
        catch { }
    }

    // --- LOGIC CAMERA ---
    private async Task StartCamera()
    {
        if (!isJsqrLoaded)
        {
            statusMessage = "Thư viện Camera chưa sẵn sàng. Vui lòng F5 lại trang.";
            statusType = "error";
            return;
        }

        isCameraActive = true;
        await InvokeAsync(StateHasChanged);

        objRef = DotNetObjectReference.Create(this);
        await Task.Delay(100);

        var success = await JS.InvokeAsync<bool>("startCamera", videoElement, canvasElement, objRef);
        if (!success)
        {
            isCameraActive = false;
            statusMessage = "Không thể mở camera. Vui lòng cấp quyền.";
            statusType = "error";
        }
    }

    private async Task StopCamera()
    {
        if (isCameraActive)
        {
            isCameraActive = false;
            await JS.InvokeVoidAsync("stopCamera");
            objRef?.Dispose();
        }
    }

    [JSInvokable]
    public async Task ProcessScan(string code)
    {
        await StopCamera();
        await SendScanRequest(code);
    }

    private async Task HandleManualSubmit()
    {
        if (!string.IsNullOrWhiteSpace(manualCode))
        {
            await SendScanRequest(manualCode);
            manualCode = "";
        }
    }

    private async Task SendScanRequest(string code)
    {
        if (occupiedStation == null) return;

        isSubmitting = true;
        statusMessage = $"Đang xử lý mã: {code}...";
        statusType = "info";
        StateHasChanged();

        try
        {
            await AttachTokenToHttp();
            var payload = new
            {
                QrCode = code,
                RtspUrl = occupiedStation.Camera?.RtspUrl ?? "",
                StationName = occupiedStation.Name
            };

            var response = await Http.PostAsJsonAsync("api/record/scan", payload);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<dynamic>();
                statusMessage = $"✅ {result.GetProperty("message")}";
                statusType = "success";
            }
            else
            {
                var errorBody = await response.Content.ReadAsStringAsync();
                statusMessage = $"❌ Lỗi: {errorBody}";
                statusType = "error";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Lỗi hệ thống: {ex.Message}";
            statusType = "error";
        }

        isSubmitting = false;
        StateHasChanged();
    }

    // Helper: Gắn token vào Header
    private async Task AttachTokenToHttp()
    {
        try
        {
            var token = await JS.InvokeAsync<string>("localStorage.getItem", "token");
            if (!string.IsNullOrEmpty(token))
            {
                Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }
        }
        catch { }
    }

    public void Dispose()
    {
        StopCamera();
        objRef?.Dispose();
    }
}