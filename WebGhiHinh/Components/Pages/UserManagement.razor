@page "/admin/users"
@using Microsoft.AspNetCore.Authorization
@using WebGhiHinh.Controllers
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Nav
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthStateProvider

@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>Quản lý Tài khoản</PageTitle>

@if (isLoading)
{
    <div class="page-container" style="display:flex; justify-content:center; align-items:center; height:80vh;">
        <div class="spinner"></div>
        <span style="margin-left: 10px; color: #666;">Đang kiểm tra quyền truy cập...</span>
    </div>
}
else if (isAuthorized)
{
    <div class="page-container fade-in">
        <div class="page-header">
            <h1>👥 Quản lý Tài khoản</h1>
            <div class="header-actions">
                <button class="btn btn-secondary btn-sm" @onclick='() => Nav.NavigateTo("/admin")'>⬅ Quay lại</button>
                <button class="btn btn-primary btn-sm" @onclick="OpenCreateModal">+ Thêm User</button>
                <button class="btn btn-warning btn-sm" @onclick="Logout">Đăng xuất</button>
            </div>
        </div>

        <div class="page-section">
            @if (!string.IsNullOrEmpty(loadError))
            {
                <div class="alert alert-danger" style="margin: 20px;">
                    <strong>⚠️ Lỗi tải dữ liệu:</strong> @loadError
                </div>
            }

            @if (users == null)
            {
                <div class="spinner"></div>
            }
            else if (users.Count == 0)
            {
                <p class="text-muted" style="padding: 20px;">Chưa có tài khoản nào.</p>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Họ tên</th>
                                <th>Mã NV</th>
                                <th>Vai trò</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var u in users)
                            {
                                <tr>
                                    <td>@u.Id</td>
                                    <td><strong>@u.Username</strong></td>
                                    <td>@u.FullName</td>
                                    <td><span class="badge bg-light text-dark border">@u.EmployeeCode</span></td>
                                    <td>
                                        @if (u.Role == "admin")
                                        {
                                            <span class="badge bg-danger">Admin (Toàn quyền)</span>
                                        }
                                        else if (u.Role == "admin1")
                                        {
                                            <span class="badge bg-warning text-dark">Admin 1 (Xem & Live)</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success">User</span>
                                        }
                                    </td>
                                    <td>
                                        <button class="btn btn-warning btn-sm" @onclick="() => OpenEditModal(u)">Sửa</button>
                                        <button class="btn btn-danger btn-sm" @onclick="() => DeleteUser(u.Id)">Xóa</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <!-- MODAL -->
    @if (showModal)
    {
        <div class="modal-backdrop fade show"></div>
        <div class="modal fade show d-block" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">@(isEditing ? "Cập nhật Tài khoản" : "Tạo Tài khoản mới")</h5>
                        <button type="button" class="btn-close" @onclick="CloseModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label>Tên đăng nhập</label>
                            <input class="form-control" @bind="currentUser.Username" disabled="@isEditing" />
                        </div>
                        <div class="mb-3">
                            <label>Mật khẩu @(isEditing ? "(Để trống nếu không đổi)" : "")</label>
                            <input type="password" class="form-control" @bind="passwordInput" />
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label>Họ tên</label>
                                <input class="form-control" @bind="currentUser.FullName" />
                            </div>
                            <div class="col-6 mb-3">
                                <label>Mã NV</label>
                                <input class="form-control" @bind="currentUser.EmployeeCode" />
                            </div>
                        </div>
                        <div class="mb-3">
                            <label>Địa chỉ</label>
                            <input class="form-control" @bind="currentUser.Address" />
                        </div>
                        <div class="mb-3">
                            <label>Vai trò</label>
                            <select class="form-select" @bind="currentUser.Role">
                                <option value="user">User (Nhân viên)</option>
                                <option value="admin">Admin (Toàn quyền)</option>
                                <!-- 👇 THÊM OPTION ADMIN 1 -->
                                <option value="admin1">Admin 1 (Chỉ xem Video/Live)</option>
                            </select>
                        </div>
                        @if (!string.IsNullOrEmpty(errorMsg))
                        {
                            <div class="alert alert-danger">@errorMsg</div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">Hủy</button>
                        <button type="button" class="btn btn-primary" @onclick="SaveUser">Lưu lại</button>
                    </div>
                </div>
            </div>
        </div>
    }
}
else
{
    <div class="alert alert-danger text-center mt-5">
        <h3>⛔ Truy cập bị từ chối</h3>
        <p>Chỉ tài khoản Admin toàn quyền mới xem được trang này.</p>
    </div>
}

@code {
    public class UserViewModel
    {
        public int Id { get; set; }
        public string Username { get; set; } = "";
        public string FullName { get; set; } = "";
        public string EmployeeCode { get; set; } = "";
        public string Address { get; set; } = "";
        public string Role { get; set; } = "user";
    }

    private List<UserViewModel> users;
    private bool showModal = false;
    private bool isEditing = false;
    private UserViewModel currentUser = new();
    private string passwordInput = "";
    private string errorMsg = "";
    private string loadError = "";
    private bool isLoading = true;
    private bool isAuthorized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (AuthStateProvider is WebGhiHinh.Services.CustomAuthStateProvider customAuth)
            {
                await customAuth.LoadUserFromLocalStorage();
            }

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            // CHỈ ADMIN GỐC MỚI ĐƯỢC VÀO QUẢN LÝ USER
            if (user.Identity.IsAuthenticated && user.IsInRole("admin"))
            {
                isAuthorized = true;
                isLoading = false;
                await LoadUsers();
                StateHasChanged();
            }
            else
            {
                isAuthorized = false;
                Nav.NavigateTo("/login");
            }
        }
    }

    private async Task LoadUsers()
    {
        try
        {
            loadError = "";
            await AttachToken();
            users = await Http.GetFromJsonAsync<List<UserViewModel>>("api/users") ?? new();
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
            users = new List<UserViewModel>();
        }
        finally { StateHasChanged(); }
    }

    private void OpenCreateModal() { isEditing = false; currentUser = new UserViewModel { Role = "user" }; passwordInput = ""; errorMsg = ""; showModal = true; }
    private void OpenEditModal(UserViewModel user) { isEditing = true; currentUser = new UserViewModel { Id = user.Id, Username = user.Username, FullName = user.FullName, EmployeeCode = user.EmployeeCode, Address = user.Address, Role = user.Role }; passwordInput = ""; errorMsg = ""; showModal = true; }
    private void CloseModal() => showModal = false;

    private async Task SaveUser()
    {
        errorMsg = "";
        if (string.IsNullOrWhiteSpace(currentUser.Username)) { errorMsg = "Thiếu username"; return; }
        if (!isEditing && string.IsNullOrWhiteSpace(passwordInput)) { errorMsg = "Thiếu password"; return; }

        try
        {
            await AttachToken();
            if (isEditing)
            {
                var updateDto = new { FullName = currentUser.FullName, EmployeeCode = currentUser.EmployeeCode, Address = currentUser.Address, Role = currentUser.Role, Password = string.IsNullOrWhiteSpace(passwordInput) ? null : passwordInput };
                var res = await Http.PutAsJsonAsync($"api/users/{currentUser.Id}", updateDto);
                if (!res.IsSuccessStatusCode) throw new Exception(await res.Content.ReadAsStringAsync());
            }
            else
            {
                var createDto = new { Username = currentUser.Username, Password = passwordInput, FullName = currentUser.FullName, EmployeeCode = currentUser.EmployeeCode, Address = currentUser.Address, Role = currentUser.Role };
                var res = await Http.PostAsJsonAsync("api/users", createDto);
                if (!res.IsSuccessStatusCode) throw new Exception(await res.Content.ReadAsStringAsync());
            }
            showModal = false; await LoadUsers();
        }
        catch (Exception ex) { errorMsg = "Lỗi: " + ex.Message; }
    }

    private async Task DeleteUser(int id)
    {
        if (!await JS.InvokeAsync<bool>("confirm", "Xóa user này?")) return;
        try { await AttachToken(); await Http.DeleteAsync($"api/users/{id}"); await LoadUsers(); } catch { }
    }

    private async Task AttachToken()
    {
        var token = await JS.InvokeAsync<string>("localStorage.getItem", "token");
        if (!string.IsNullOrEmpty(token)) Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
    }

    private async Task Logout()
    {
        await JS.InvokeVoidAsync("localStorage.clear");
        if (AuthStateProvider is WebGhiHinh.Services.CustomAuthStateProvider customAuth) await customAuth.MarkUserAsLoggedOut();
        Nav.NavigateTo("/login", true);
    }
}