@page "/live"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.JSInterop
@using System.Net.Http.Headers
@using WebGhiHinh.Models
@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@implements IAsyncDisposable
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<div class="live-container fade-in">
    <header class="page-header">
        <div class="header-left">
            <h1>📡 Trung Tâm Điều Hành</h1>
            <div class="header-sub">
                Chế độ:
                <span class="fw-bold @(isAutoScanMode ? "text-success" : "text-primary")">
                    @(isAutoScanMode ? "🤖 SERVER AUTO SCAN" : "📺 CHỈ XEM (Live Stream)")
                </span>
            </div>
        </div>

        <div class="header-right">
            <button class="btn btn-sm rounded-pill px-4 py-2 fw-bold @(isAutoScanMode ? "btn-danger" : "btn-primary")"
                    @onclick="ToggleScanMode">
                @if (isAutoScanMode)
                {
                    <span>⏹ Dừng Overlay</span>
                }
                else
                {
                    <span>▶ Bật Overlay</span>
                }
            </button>
            <span class="status-badge ms-3">
                <span class="live-dot"></span> Online
            </span>
        </div>
    </header>

    @if (loading)
    {
        <div class="spinner-container">
            <div class="spinner"></div>
            <p>Đang tải dữ liệu...</p>
        </div>
    }
    else if (stations.Count == 0)
    {
        <div class="empty-state">
            <p>Chưa có trạm nào.</p>
        </div>
    }
    else
    {
        <div class="grid-layout">
            @foreach (var st in stations)
            {
                var hasRec = recordingStatus.TryGetValue(st.Name, out var currentQr);
                var userText = st.CurrentUser == null
                    ? "---"
                    : st.CurrentUser.FullName ?? st.CurrentUser.Username;

                overlayByStation.TryGetValue(st.Name, out var ov);

                <div class="station-card @(hasRec ? "recording-border" : "")">
                    <div class="card-header-custom">
                        <div class="d-flex align-items-center gap-2">
                            <span class="station-name">@st.Name</span>
                            <span class="badge bg-light text-dark border">👤 @userText</span>
                        </div>
                        <div>
                            @if (hasRec)
                            {
                                <span class="badge bg-danger animate-pulse">
                                    🔴 REC: @currentQr
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-success">Ready</span>
                            }
                        </div>
                    </div>

                    <div class="cams-row">
                        <!-- Overview cam -->
                        <div class="cam-wrapper">
                            <div class="cam-label">Overview</div>
                            @if (st.OverviewCamera?.RtspUrl != null)
                            {
                                <iframe class="video-fill"
                                        scrolling="no"
                                        src="@($"{StreamBaseUrl}/{st.OverviewCamera.Name}/")">
                                </iframe>
                            }
                            else
                            {
                                <div class="no-signal">No Signal</div>
                            }
                        </div>

                        <!-- QR cam -->
                        <div class="cam-wrapper">
                            <div class="d-flex justify-content-between cam-label-row">
                                <div class="cam-label">QR Cam</div>
                                @if (isAutoScanMode)
                                {
                                    <span class="text-success small fw-bold animate-pulse">
                                        ⚡ SERVER SCAN
                                    </span>
                                }
                            </div>

                            <div class="scan-container-relative">
                                @if (st.QrCamera?.RtspUrl != null)
                                {
                                    <!-- Chỉ phát video, không decode ở client -->
                                    <iframe class="video-fill"
                                            scrolling="no"
                                            src="@($"{StreamBaseUrl}/{st.QrCamera.Name}/")">
                                    </iframe>

                                    <!-- Overlay được vẽ từ dữ liệu server (SignalR -> Blazor) -->
                                    @if (ov is not null && isAutoScanMode)
                                    {
                                        <div class="qr-overlay-root">
                                            <div class="qr-overlay-box"
                                                 style="
                                                    left:@(ov.X * 100)%;
                                                    top:@(ov.Y * 100)%;
                                                    width:@(ov.W * 100)%;
                                                    height:@(ov.H * 100)%;">
                                            </div>
                                            <div class="qr-overlay-label">
                                                @ov.Code
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="no-signal">No QR Cam</div>
                                }
                            </div>
                        </div>
                    </div>

                    @if (scanLogs.TryGetValue(st.Name, out var logs) && logs.Any())
                    {
                        var lastLog = logs.First();
                        <div class="mini-log">
                            <small class="text-muted">
                                @lastLog.Time.ToString("HH:mm:ss"):
                            </small>
                            <span class="fw-bold">@lastLog.QrCode</span>
                            <span class="badge @(lastLog.Action == "error" ? "bg-danger" : "bg-info")">
                                @lastLog.Message
                            </span>
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    private List<Station> stations = new();
    private Dictionary<string, string> recordingStatus = new();
    private Dictionary<string, List<ScanLogEntry>> scanLogs = new();

    // Overlay mỗi trạm
    private class ScanOverlayInfo
    {
        public string Code { get; set; } = "";
        public double X { get; set; }
        public double Y { get; set; }
        public double W { get; set; }
        public double H { get; set; }
        public DateTime Time { get; set; }
    }

    private readonly Dictionary<string, ScanOverlayInfo> overlayByStation = new();

    private bool loading = true;
    private bool isAutoScanMode = true;   // server luôn scan, chỉ bật/tắt hiển thị overlay

    private string StreamBaseUrl = "http://localhost:8889";
    private string HlsBaseUrl = "http://localhost:8888";

    private System.Threading.Timer? statusTimer;
    private System.Threading.Timer? overlayCleanerTimer;
    private DotNetObjectReference<LiveCameraPage>? objRef;

    private class ScanLogEntry
    {
        public DateTime Time { get; set; }
        public string QrCode { get; set; } = "";
        public string Action { get; set; } = "";
        public string Message { get; set; } = "";
    }

    protected override Task OnInitializedAsync()
    {
        try
        {
            var uri = new Uri(Nav.BaseUri);
            StreamBaseUrl = $"http://{uri.Host}:8889";
            HlsBaseUrl = $"http://{uri.Host}:8888";
        }
        catch { }

        objRef = DotNetObjectReference.Create(this);
        return Task.CompletedTask;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadStations();

            // Timer cập nhật trạng thái đang quay
            statusTimer = new System.Threading.Timer(async _ => await CheckRecordingStatus(),
                                                     null, 0, 1000);

            // Timer dọn overlay > 5s
            overlayCleanerTimer = new System.Threading.Timer(_ => CleanupOverlays(),
                                                             null, 5000, 1000);

            // Kết nối JS (SignalR client)
            if (objRef != null)
            {
                await JS.InvokeVoidAsync("scanOverlay.init", objRef);
            }
        }
    }

    private void CleanupOverlays()
    {
        var cutoff = DateTime.Now.AddSeconds(-5);
        var keys = overlayByStation
            .Where(kv => kv.Value.Time < cutoff)
            .Select(kv => kv.Key)
            .ToList();

        if (keys.Count == 0) return;

        foreach (var k in keys)
            overlayByStation.Remove(k);

        InvokeAsync(StateHasChanged);
    }

    private Task ToggleScanMode()
    {
        isAutoScanMode = !isAutoScanMode;
        return Task.CompletedTask;
    }

    // 🧠 Hàm này được JS gọi khi Worker bắn ScanResult qua SignalR
    [JSInvokable]
    public Task OnScanResultFromServer(
        string stationName,
        string code,
        double x,
        double y,
        double w,
        double h)
    {
        if (string.IsNullOrWhiteSpace(stationName) || string.IsNullOrWhiteSpace(code))
            return Task.CompletedTask;

        overlayByStation[stationName] = new ScanOverlayInfo
        {
            Code = code,
            X = x,
            Y = y,
            W = w,
            H = h,
            Time = DateTime.Now
        };

        // log mini
        if (!scanLogs.ContainsKey(stationName))
            scanLogs[stationName] = new();

        scanLogs[stationName].Insert(0, new ScanLogEntry
        {
            Time = DateTime.Now,
            QrCode = code,
            Action = "scan",
            Message = "Server scan"
        });

        if (scanLogs[stationName].Count > 5)
            scanLogs[stationName].RemoveAt(scanLogs[stationName].Count - 1);

        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task LoadStations()
    {
        try
        {
            loading = true;
            StateHasChanged();

            await AttachToken();
            stations = await Http.GetFromJsonAsync<List<Station>>("api/station") ?? new();
            stations = stations.OrderBy(s => s.Name).ToList();
        }
        catch
        {
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private async Task CheckRecordingStatus()
    {
        try
        {
            await AttachToken();
            var rs = await Http.GetFromJsonAsync<Dictionary<string, string>>("api/record/recording-status");
            if (rs != null)
            {
                recordingStatus = rs;
                await InvokeAsync(StateHasChanged);
            }
        }
        catch
        {
        }
    }

    private async Task AttachToken()
    {
        var t = await JS.InvokeAsync<string>("localStorage.getItem", "token");
        if (!string.IsNullOrEmpty(t))
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", t);
    }

    public ValueTask DisposeAsync()
    {
        statusTimer?.Dispose();
        overlayCleanerTimer?.Dispose();
        objRef?.Dispose();
        return ValueTask.CompletedTask;
    }
}
