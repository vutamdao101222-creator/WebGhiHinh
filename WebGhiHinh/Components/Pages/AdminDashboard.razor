@page "/admin"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Web
@using WebGhiHinh.Models
@using WebGhiHinh.Controllers
@using Microsoft.AspNetCore.Components.Authorization
@using System.IO

@* 👇 NAMESPACE CHỨA CustomAuthStateProvider *@
@using WebGhiHinh.Services
@using WebGhiHinh.Data

@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider

@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>Admin Dashboard</PageTitle>

<!-- 👇 CHO PHÉP CẢ 'admin' VÀ 'admin1' -->
<AuthorizeView Roles="admin, admin1">
    <Authorized>
        <div class="page-container fade-in">
            <!-- =========================================
                 1. THANH ĐIỀU HƯỚNG (NAVBAR)
                 ========================================= -->
            <div class="admin-navbar mb-4">
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary @(IsActive("/admin") ? "active" : "")" @onclick='() => Nav.NavigateTo("/admin")'>🏠 Dashboard</button>
                    <!-- Nút Scan -->
                    <button class="btn btn-outline-primary @(IsActive("/scan") ? "active" : "")" @onclick='() => Nav.NavigateTo("/scan")'>📷 Quét QR</button>
                    <button class="btn btn-outline-primary @(IsActive("/live") ? "active" : "")" @onclick='() => Nav.NavigateTo("/live")'>📺 Xem Live</button>
                    
                    <!-- 👇 CHỈ ADMIN TOÀN QUYỀN MỚI THẤY NÚT QUẢN LÝ -->
                    @if (isFullAdmin)
                    {
                        <button class="btn btn-outline-primary @(IsActive("/admin/stations") ? "active" : "")" @onclick='() => Nav.NavigateTo("/admin/stations")'>🚉 Quản lý Trạm</button>
                        <button class="btn btn-outline-primary @(IsActive("/admin/users") ? "active" : "")" @onclick='() => Nav.NavigateTo("/admin/users")'>👥 Quản lý Users</button>
                    }
                </div>
                <div class="header-actions">
                    <!-- Hiển thị Badge khác nhau tùy quyền -->
                    @if (isFullAdmin)
                    {
                        <span class="admin-badge" style="background-color: #dc3545;">Administrator</span>
                    }
                    else
                    {
                        <span class="admin-badge" style="background-color: #ffc107; color: #000;">Admin 1 (View Only)</span>
                    }
                    <button class="btn btn-secondary btn-sm" @onclick="Logout">Đăng xuất</button>
                </div>
            </div>

            <div class="page-header">
                <h1>🛠️ Admin Dashboard</h1>
            </div>

            <!-- ... QUẢN LÝ CAMERA ... -->
            <div class="page-section">
                <h2 class="section-title">📷 Danh sách Camera</h2>
                
                <!-- 👇 CHỈ ADMIN TOÀN QUYỀN MỚI ĐƯỢC THÊM CAMERA -->
                @if (isFullAdmin)
                {
                    <div class="camera-form">
                        <input @bind="newCamName" class="admin-input" placeholder="Tên Camera (VD: Cam1)" />
                        <input @bind="newCamRtsp" class="admin-input" placeholder="RTSP URL (rtsp://...)" />
                        <button class="btn btn-primary" @onclick="AddCamera" disabled="@isBusy">
                            @(isBusy ? "..." : "+ Thêm")
                        </button>
                    </div>
                }

                <ul class="camera-list">
                    @foreach (var cam in cameras)
                    {
                        <li class="camera-item">
                            @if (editingCamId == cam.Id)
                            {
                                <div class="edit-row">
                                    <input @bind="editCamName" @bind:event="oninput" class="admin-input" placeholder="Tên Camera" />
                                    <input @bind="editCamRtsp" @bind:event="oninput" class="admin-input" placeholder="RTSP URL" />
                                    <div class="action-group">
                                        <button class="btn btn-success btn-sm" @onclick="() => SaveCamera(cam.Id)">Lưu</button>
                                        <button class="btn btn-secondary btn-sm" @onclick="CancelEdit">Hủy</button>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="view-row">
                                    <div class="info">
                                        <strong class="cam-name">@cam.Name</strong>
                                        <code class="cam-url">@cam.RtspUrl</code>
                                    </div>
                                    
                                    <!-- 👇 ADMIN 1 CHỈ XEM, KHÔNG CÓ NÚT SỬA/XÓA -->
                                    @if (isFullAdmin)
                                    {
                                        <div class="actions">
                                            <button class="btn btn-warning btn-sm" @onclick="() => StartEdit(cam)">Sửa</button>
                                            <button class="btn btn-danger btn-sm" @onclick="() => DeleteCamera(cam.Id)">Xóa</button>
                                        </div>
                                    }
                                </div>
                            }
                        </li>
                    }
                </ul>
            </div>

            <!-- ... QUẢN LÝ VIDEO ... -->
            <div class="page-section">
                <div class="section-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h2 class="section-title mb-0">🎬 Quản lý Video</h2>
                    
                    <div class="d-flex gap-2 align-items-center">
                        <div class="input-group input-group-sm" style="width: 250px;">
                            <input type="text" 
                                   class="form-control" 
                                   placeholder="🔍 Tìm Mã QR..." 
                                   @bind="searchQrKeyword" 
                                   @bind:event="oninput" 
                                   @onkeyup="FilterVideos"/>
                            <button class="btn btn-outline-secondary" @onclick="FilterVideos">Tìm</button>
                        </div>

                        <button class="btn btn-success btn-sm" @onclick="ExportExcel">📥 Xuất Excel</button>
                    </div>
                </div>

                @if (filteredVideos.Count == 0)
                {
                    <p class="text-muted mt-3">Không tìm thấy video nào.</p>
                }
                else
                {
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                        <table class="table admin-table">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">STT</th>
                                    <th>Mã QR</th>
                                    <th>Người ghi</th>
                                    <th>Trạm</th>
                                    <th>Thời gian</th>
                                    <th>Hành động</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{ int stt = 1; }
                                @foreach (var v in filteredVideos)
                                {
                                    <tr>
                                        <td>@(stt++)</td>
                                        <td><span class="badge-qr">@v.QrCode</span></td>
                                        <td>@v.RecordedBy</td>
                                        <td>@v.StationName</td>
                                        <td>@v.StartTime.ToString("dd/MM/yyyy HH:mm")</td>
                                        <td>
                                            <!-- Nút XEM -->
                                            <button class="btn btn-info btn-sm text-white" @onclick="() => ViewVideo(v)" style="margin-right:5px;">👁️ Xem</button>
                                            
                                            <!-- Nút XÓA (Chỉ Admin) -->
                                            @if (isFullAdmin)
                                            {
                                                <button class="btn btn-danger btn-sm" @onclick="() => DeleteVideo(v.Id)">Xóa</button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>

            <!-- =========================================
                 2. CÀI ĐẶT HỆ THỐNG (CHỈ ADMIN TOÀN QUYỀN)
                 ========================================= -->
            @if (isFullAdmin)
            {
                <div class="page-section mt-4">
                    <h2 class="section-title">⚙️ Cài đặt hệ thống</h2>
                    <div class="settings-card p-4 border rounded bg-light">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tự động xóa video sau (ngày):</label>
                            <div class="d-flex gap-2" style="max-width: 300px;">
                                <input type="number" class="form-control" @bind="retentionDays" min="1" max="365" />
                                <button class="btn btn-primary" @onclick="SaveSettings" disabled="@isSavingSettings">
                                    @(isSavingSettings ? "Đang lưu..." : "Lưu cài đặt")
                                </button>
                            </div>
                            <small class="text-muted">Hệ thống sẽ tự động quét và xóa các video cũ hơn số ngày này vào lúc 00:00 hàng ngày.</small>
                        </div>
                        @if (!string.IsNullOrEmpty(settingMessage))
                        {
                            <div class="alert alert-info mt-2">@settingMessage</div>
                        }
                    </div>
                </div>
            }

        </div>

        <!-- ... (Phần Modal Video ĐÃ CẬP NHẬT TUA) ... -->
        @if (showVideoModal)
        {
            <div class="modal-backdrop fade show"></div>
            <!-- 👇 Thêm @ref, @onkeydown và style outline để bắt phím -->
            <div class="modal fade show d-block" tabindex="-1" 
                 @ref="videoModalRef" 
                 @onkeydown="HandleModalKeyDown"
                 style="outline: none;">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">🎬 Xem lại: @currentVideoTitle</h5>
                            <button type="button" class="btn-close" @onclick="CloseVideoModal"></button>
                        </div>
                        <div class="modal-body text-center bg-black">
                            <!-- 👇 Thêm ID để JS tìm thấy -->
                            <video id="adminVideoPlayer" controls autoplay style="width: 100%; max-height: 60vh;">
                                <source src="@currentVideoUrl" type="video/mp4">
                                Trình duyệt của bạn không hỗ trợ thẻ video.
                            </video>

                            <!-- 👇 THANH ĐIỀU KHIỂN TUA VIDEO -->
                            <div class="mt-3 d-flex justify-content-center gap-3">
                                <button class="btn btn-outline-light" @onclick="() => SeekVideo(-10)">
                                    ⏪ Lùi 10s
                                </button>
                                <button class="btn btn-outline-light" @onclick="() => SeekVideo(-5)">
                                    ⏪ 5s (←)
                                </button>
                                <button class="btn btn-outline-light" @onclick="() => SeekVideo(5)">
                                    5s ⏩ (→)
                                </button>
                                <button class="btn btn-outline-light" @onclick="() => SeekVideo(10)">
                                    Tiến 10s ⏩
                                </button>
                            </div>
                            <div class="text-white mt-2 small">
                                💡 Mẹo: Dùng phím mũi tên Trái/Phải để tua nhanh
                            </div>
                        </div>
                        <div class="modal-footer">
                            <a href="@currentVideoUrl" download="@currentVideoTitle" class="btn btn-primary">⬇️ Tải về</a>
                            <button type="button" class="btn btn-secondary" @onclick="CloseVideoModal">Đóng</button>
                        </div>
                    </div>
                </div>
            </div>
        }

    </Authorized>
    <NotAuthorized>
        <div class="d-flex flex-column justify-content-center align-items-center" style="height: 50vh;">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <div class="text-muted">Đang kiểm tra quyền Admin...</div>
            <button class="btn btn-link mt-3 text-muted" @onclick='() => Nav.NavigateTo("/login")' style="font-size: 0.9rem;">
                Không tự động chuyển? Bấm vào đây.
            </button>
        </div>
    </NotAuthorized>
</AuthorizeView>

<style>
    .admin-navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #eee;
        padding-bottom: 15px;
    }

    .active {
        background-color: #0d6efd;
        color: white;
    }
</style>

@code {
    // ... (Giữ nguyên các biến State cũ) ...
    private List<Camera> cameras = new();
    private List<VideoLog> videos = new(); // Gốc
    private List<VideoLog> filteredVideos = new(); // Hiển thị
    
    private string newCamName = "";
    private string newCamRtsp = "";
    private int? editingCamId = null;
    private string editCamName = "";
    private string editCamRtsp = "";
    private bool isBusy = false;
    private bool showVideoModal = false;
    private string currentVideoUrl = "";
    private string currentVideoTitle = "";

    private string searchQrKeyword = "";

    // Settings
    private int retentionDays = 30; 
    private bool isSavingSettings = false;
    private string settingMessage = "";
    
    // Quyền
    private bool isFullAdmin = false;

    // 👇 Tham chiếu đến Modal để Focus
    private ElementReference videoModalRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (AuthStateProvider is CustomAuthStateProvider customAuth)
            {
                await customAuth.LoadUserFromLocalStorage();
            }

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            if (!user.Identity.IsAuthenticated)
            {
                Nav.NavigateTo("/login");
                return;
            }

            bool isRoleAdmin = user.IsInRole("admin");
            bool isRoleAdmin1 = user.IsInRole("admin1");

            if (!isRoleAdmin && !isRoleAdmin1)
            {
                Nav.NavigateTo("/login"); 
                return;
            }

            isFullAdmin = isRoleAdmin;

            await LoadData();
            if (isFullAdmin) await LoadSettings();
            StateHasChanged();
        }
    }

    private bool IsActive(string href) => Nav.Uri.EndsWith(href, StringComparison.OrdinalIgnoreCase);

    private async Task LoadData()
    {
        try
        {
            await AttachToken();
            cameras = await Http.GetFromJsonAsync<List<Camera>>("api/cameras") ?? new();
            videos = await Http.GetFromJsonAsync<List<VideoLog>>("api/videos") ?? new();
            FilterVideos(); 
        }
        catch { }
    }

    private void FilterVideos()
    {
        if (string.IsNullOrWhiteSpace(searchQrKeyword))
        {
            filteredVideos = videos.ToList();
        }
        else
        {
            filteredVideos = videos
                .Where(v => !string.IsNullOrEmpty(v.QrCode) && 
                            v.QrCode.Contains(searchQrKeyword, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }

    // 👇 CẬP NHẬT HÀM NÀY: Chuyển thành Async để Focus vào Modal
    private async Task ViewVideo(VideoLog video)
    {
        try
        {
            var fileName = Path.GetFileName(video.FilePath);
            currentVideoUrl = $"videos/{video.StationName}/{fileName}";
            currentVideoTitle = $"{video.QrCode} ({video.StationName})";
            showVideoModal = true;
            
            // Render lại UI để Modal xuất hiện
            StateHasChanged();
            
            // Đợi 1 chút để DOM cập nhật xong
            await Task.Delay(100);
            
            // Focus vào Modal để nhận phím ngay lập tức
            await videoModalRef.FocusAsync();
        }
        catch { }
    }
    
    private void CloseVideoModal() { showVideoModal = false; currentVideoUrl = ""; }

    // 👇 HÀM XỬ LÝ PHÍM BẤM
    private async Task HandleModalKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "ArrowLeft")
        {
            await SeekVideo(-5); // Lùi 5s
        }
        else if (e.Key == "ArrowRight")
        {
            await SeekVideo(5); // Tiến 5s
        }
        else if (e.Code == "Space")
        {
            // Tùy chọn: Space để Pause/Play
            await JS.InvokeVoidAsync("eval", "var v = document.getElementById('adminVideoPlayer'); if(v.paused) v.play(); else v.pause();");
        }
    }

    // 👇 HÀM TUA VIDEO (SEEK)
    private async Task SeekVideo(int seconds)
    {
        try
        {
            // Gọi lệnh JS trực tiếp để chỉnh thời gian video
            await JS.InvokeVoidAsync("eval", $"var v = document.getElementById('adminVideoPlayer'); if(v) v.currentTime += {seconds};");
        }
        catch { }
    }

    private async Task AddCamera()
    {
        if (string.IsNullOrWhiteSpace(newCamName)) return;
        await AttachToken();
        await Http.PostAsJsonAsync("api/cameras", new Camera { Name = newCamName, RtspUrl = newCamRtsp });
        newCamName = ""; newCamRtsp = ""; await LoadData();
    }
    private async Task DeleteCamera(int id)
    {
        if (await JS.InvokeAsync<bool>("confirm", "Xóa camera này?"))
        {
            await AttachToken(); await Http.DeleteAsync($"api/cameras/{id}"); await LoadData();
        }
    }
    private void StartEdit(Camera c) { editingCamId = c.Id; editCamName = c.Name; editCamRtsp = c.RtspUrl; }
    private void CancelEdit() => editingCamId = null;

    private async Task SaveCamera(int id)
    {
        try 
        {
            await AttachToken();
            var res = await Http.PutAsJsonAsync($"api/cameras/{id}", new Camera { Id = id, Name = editCamName, RtspUrl = editCamRtsp });
            
            if (res.IsSuccessStatusCode)
            {
                editingCamId = null;
                await LoadData();
                await JS.InvokeVoidAsync("alert", "✅ Cập nhật thành công!");
            }
            else
            {
                var err = await res.Content.ReadAsStringAsync();
                if (string.IsNullOrWhiteSpace(err)) err = $"Lỗi {(int)res.StatusCode}";
                await JS.InvokeVoidAsync("alert", $"❌ Lỗi cập nhật: {err}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"❌ Lỗi kết nối: {ex.Message}");
        }
    }

    private async Task ExportExcel()
    {
        try
        {
            await AttachToken();
            var res = await Http.GetAsync("api/videos/export");
            if (res.IsSuccessStatusCode)
            {
                var content = await res.Content.ReadAsByteArrayAsync();
                await JS.InvokeVoidAsync("downloadFileFromStream", $"BaoCao_{DateTime.Now:yyyyMMdd}.xlsx", Convert.ToBase64String(content));
            }
        }
        catch { }
    }
    private async Task Logout()
    {
        await JS.InvokeVoidAsync("localStorage.clear"); Nav.NavigateTo("/login", true);
    }
    private async Task AttachToken()
    {
        var token = await JS.InvokeAsync<string>("localStorage.getItem", "token");
        if (!string.IsNullOrEmpty(token)) Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
    }

    private async Task DeleteVideo(int id)
    {
        if (!isFullAdmin) return;

        if (!await JS.InvokeAsync<bool>("confirm", "Hành động này sẽ XÓA VĨNH VIỄN file video khỏi ổ cứng. Tiếp tục?")) return;

        await AttachToken();
        var res = await Http.DeleteAsync($"api/videos/{id}");
        if (res.IsSuccessStatusCode)
        {
            await LoadData();
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Lỗi xóa video!");
        }
    }

    private async Task LoadSettings()
    {
        try
        {
            await AttachToken();
            var days = await Http.GetFromJsonAsync<int>("api/videos/retention");
            retentionDays = days > 0 ? days : 30;
        }
        catch { }
    }

    private async Task SaveSettings()
    {
        isSavingSettings = true;
        try
        {
            await AttachToken();
            var res = await Http.PostAsJsonAsync("api/videos/retention", retentionDays);
            if (res.IsSuccessStatusCode)
            {
                settingMessage = "✅ Đã lưu cài đặt thành công!";
            }
            else
            {
                settingMessage = "❌ Lỗi khi lưu cài đặt.";
            }
        }
        catch (Exception ex)
        {
            settingMessage = "Lỗi: " + ex.Message;
        }
        isSavingSettings = false;
        await Task.Delay(3000);
        settingMessage = "";
        StateHasChanged();
    }
}