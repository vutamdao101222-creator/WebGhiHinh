@* FILE: Components/Pages/StationAdminPage.razor *@
@page "/admin/stations"
@using Microsoft.AspNetCore.Authorization
@using System.Net.Http.Headers
@using WebGhiHinh.Models
@inject HttpClient Http
@inject IJSRuntime JS

@attribute [Authorize(Roles = "admin,admin1")]
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>Quản lý Trạm & 2 Camera</PageTitle>

<div class="container py-3">
    <h3 class="mb-3">Gán 2 camera cho trạm (Overview + QR)</h3>

    @if (loading)
    {
        <div class="spinner"></div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-sm table-striped align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width:160px;">Trạm</th>
                        <th>Overview Camera</th>
                        <th>QR Camera</th>
                        <th style="width:120px;"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var s in stations)
                    {
                        <tr>
                            <td class="fw-semibold">@s.Name</td>

                            <td>
                                <select class="form-select form-select-sm" @bind="s.OverviewCameraId">
                                    <option value="">-- Chọn camera --</option>
                                    @foreach (var c in cameras)
                                    {
                                        <option value="@c.Id">@c.Name</option>
                                    }
                                </select>
                            </td>

                            <td>
                                <select class="form-select form-select-sm" @bind="s.QrCameraId">
                                    <option value="">-- Chọn camera --</option>
                                    @foreach (var c in cameras)
                                    {
                                        <option value="@c.Id">@c.Name</option>
                                    }
                                </select>
                            </td>

                            <td class="text-end">
                                <button class="btn btn-sm btn-primary"
                                        @onclick="() => SaveStationCameras(s)">
                                    Lưu
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (!string.IsNullOrWhiteSpace(message))
        {
            <div class="alert alert-info py-2 mt-2">@message</div>
        }
    }
</div>

@code {
    private List<Station> stations = new();
    private List<Camera> cameras = new();
    private bool loading = true;
    private string message = "";

    protected override async Task OnInitializedAsync()
    {
        await AttachTokenToHttp();
        await LoadAll();
    }

    private async Task LoadAll()
    {
        try
        {
            stations = await Http.GetFromJsonAsync<List<Station>>("api/station") ?? new();
            cameras = await Http.GetFromJsonAsync<List<Camera>>("api/cameras") ?? new();
        }
        catch (Exception ex)
        {
            message = ex.Message;
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private async Task SaveStationCameras(Station s)
    {
        try
        {
            await AttachTokenToHttp();

            var res = await Http.PostAsJsonAsync("api/station/set-cameras", new
            {
                StationId = s.Id,
                OverviewCameraId = s.OverviewCameraId,
                QrCameraId = s.QrCameraId
            });

            message = res.IsSuccessStatusCode ? $"✅ Đã lưu {s.Name}" : $"❌ Lỗi lưu {s.Name}";
        }
        catch (Exception ex)
        {
            message = ex.Message;
        }

        StateHasChanged();
    }

    private async Task AttachTokenToHttp()
    {
        try
        {
            var t = await JS.InvokeAsync<string>("auth.get");
            if (!string.IsNullOrEmpty(t))
            {
                Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", t);
                return;
            }
        }
        catch { }

        try
        {
            var t2 = await JS.InvokeAsync<string>("localStorage.getItem", "token");
            if (!string.IsNullOrEmpty(t2))
                Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", t2);
        }
        catch { }
    }
}
